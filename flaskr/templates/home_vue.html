<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{name}} - Control Panel</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='libs/bulma.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='modern-style.css') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16x16.png') }}">
    <meta name="mobile-web-app-capable" content="yes">
    <style>
        .hero {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card {
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-active {
            background-color: #48c774;
        }
        .status-inactive {
            background-color: #f14668;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Loading Overlay -->
        <div v-if="loading" class="loading-overlay">
            <div class="has-text-white has-text-centered">
                <div class="is-size-1 mb-4">‚è≥</div>
                <p class="is-size-4">Procesando...</p>
            </div>
        </div>

        <!-- Hero Section -->
        <section class="hero is-primary">
            <div class="hero-body">
                <div class="container">
                    <h1 class="title is-2">{{name}}</h1>
                    <h2 class="subtitle">Panel de Control del Sistema</h2>
                    <p class="is-size-6">√öltimo update: {{ current_time }}</p>
                </div>
            </div>
        </section>

        <!-- Main Content -->
        <section class="section">
            <div class="container">
                <!-- Devices Section -->
                <div v-if="devices && devices.length > 0" class="section">
                    <h2 class="title is-4">ü§ñ Dispositivos Conectados</h2>
                    <div class="columns is-multiline">
                        <div v-for="device in devices" :key="device.ip" class="column is-3">
                            <div class="card">
                                <div class="card-content has-text-centered">
                                    <figure class="image is-64x64 is-inline-block mb-3">
                                        <img :src="getDeviceIcon(device.hostname)" :alt="device.hostname" style="border-radius: 8px;">
                                    </figure>
                                    <p class="title is-6">${ device.hostname }</p>
                                    <p class="subtitle is-7">${ device.ip }</p>
                                    <button @click="openDevice(device.ip)" class="button is-small is-primary">
                                        Abrir Panel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="columns">
                    <!-- Status Column -->
                    <div class="column is-6">
                        <div class="card">
                            <div class="card-header">
                                <p class="card-header-title">Estado de Servicios</p>
                            </div>
                            <div class="card-content">
                                <div class="content">
                                    <div class="field">
                                        <label class="label">Servidor</label>                        <div class="control">
                            <span class="status-indicator" :class="serverStatus ? 'status-active' : 'status-inactive'"></span>
                            <span v-text="serverStatus ? 'Activo' : 'Inactivo'"></span>
                        </div>
                                    </div>
                                    <div class="field">
                                        <label class="label">LGPT</label>                        <div class="control">
                            <span class="status-indicator" :class="lgptStatus ? 'status-active' : 'status-inactive'"></span>
                            <span v-text="lgptStatus ? 'Activo' : 'Inactivo'"></span>
                        </div>
                                    </div>
                                    <div class="field">
                                        <label class="label">Registros procesados</label>
                                        <div class="control">
                                            <span class="tag is-info is-large">${ lineCount }</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configuration Column -->
                    <div class="column is-6">
                        <div class="card">
                            <div class="card-header">
                                <p class="card-header-title">Configuraci√≥n</p>
                            </div>
                            <div class="card-content">
                                <form @submit.prevent="restartService">
                                    <div class="field">
                                        <label class="label">Delay (ms)</label>
                                        <div class="control">
                                            <input v-model.number="config.delay" class="input" type="number" min="0" max="1000">
                                        </div>
                                    </div>
                                    <div class="field">
                                        <div class="control">
                                            <label class="checkbox">
                                                <input v-model="config.debug" type="checkbox">
                                                Modo Debug
                                            </label>
                                        </div>
                                    </div>
                                    <div class="field">
                                        <div class="control">
                                            <label class="checkbox">
                                                <input v-model="config.ruido" @change="updateRuido" type="checkbox">
                                                Filtro de Ruido
                                            </label>
                                        </div>
                                    </div>
                                    <div class="field">
                                        <div class="control">
                                            <button class="button is-primary is-fullwidth" type="submit" :class="{'is-loading': loading}">
                                                Reiniciar Servicio
                                            </button>
                                        </div>
                                    </div>
                                    <div class="field">
                                        <div class="control">
                                            <button @click="cleanData" class="button is-warning is-fullwidth" :class="{'is-loading': loading}" type="button">
                                                Limpiar Datos
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="section">
                    <div class="buttons is-centered">
                        <a href="/robot" class="button is-large is-success">
                            <span>ü§ñ Estado del Robot</span>
                        </a>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script src="{{ url_for('static', filename='libs/vue.js') }}"></script>
    <script src="{{ url_for('static', filename='libs/axios.js') }}"></script>
    <script>
        const { createApp } = Vue;

        createApp({
            delimiters: ['${', '}'],
            data() {
                return {
                    loading: false,
                    serverStatus: {{ is_active|tojson }},
                    lgptStatus: {{ lgpt_is_active|tojson }},
                    lineCount: {{ line_count }},
                    devices: {{ devices|tojson }},
                    config: {
                        delay: {{ config.delay if config.delay else 0 }},
                        debug: {{ config.debug|tojson if config.debug else 'false' }},
                        ruido: {{ config.ruido|tojson if config.ruido else 'false' }}
                    }
                }
            },
            methods: {
                async restartService() {
                    this.loading = true;
                    try {
                        const formData = new FormData();
                        formData.append('delay', this.config.delay);
                        formData.append('debug', this.config.debug);

                        const response = await axios.post('/', formData);
                        
                        if (response.data.status === 'ok') {
                            setTimeout(() => {
                                location.reload();
                            }, 3000);
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error al reiniciar el servicio');
                    } finally {
                        this.loading = false;
                    }
                },
                async updateRuido() {
                    try {
                        const formData = new FormData();
                        formData.append('ruido', this.config.ruido);
                        await axios.post('/ruido', formData);
                    } catch (error) {
                        console.error('Error updating ruido:', error);
                    }
                },
                async cleanData() {
                    this.loading = true;
                    try {
                        await axios.post('/limpia');
                        location.reload();
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error al limpiar datos');
                    } finally {
                        this.loading = false;
                    }
                },
                getDeviceIcon(deviceName) {
                    // Mapeo de nombres de dispositivos a iconos
                    const iconMap = {
                        'maleta': 'carmen.png',
                        'sombrilla': 'obdulia.png',
                        'default': 'obdulia.jpg'
                    };
                    
                    const iconName = iconMap[deviceName.toLowerCase()] || iconMap['default'];
                    return `/static/${iconName}`;
                },
                openDevice(ip) {
                    window.open(`http://${ip}:8080/robot`, '_blank');
                },
                async updateLineCount() {
                    try {
                        const response = await axios.get('/proceso');
                        this.lineCount = response.data.data;
                    } catch (error) {
                        console.error('Error updating line count:', error);
                    }
                }
            },
            mounted() {
                // Update line count every 5 seconds
                setInterval(() => {
                    this.updateLineCount();
                }, 5000);
            }
        }).mount('#app');
    </script>
</body>
</html>
